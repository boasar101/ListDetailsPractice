package com.example.listdetailspractice

import androidx.compose.foundation.layout.padding
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.List
import androidx.compose.material.icons.filled.Settings
import androidx.compose.material.icons.filled.Star
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavType
import androidx.navigation.compose.*
import androidx.navigation.navArgument
import com.example.listdetailspractice.ui.screens.FavoritesScreen
import com.example.listdetailspractice.ui.screens.RepoDetailsScreen
import com.example.listdetailspractice.ui.screens.ReposListScreen
import com.example.listdetailspractice.ui.screens.SettingsRoute
import com.example.listdetailspractice.ui.vm.*

sealed class BottomDest(val route: String, val label: String) {
    data object Repos : BottomDest("repos_list", "Repos")
    data object Favorites : BottomDest("favorites", "Fav")
    data object Settings : BottomDest("settings", "Settings")
}

@Composable
fun AppRoot() {
    val navController = rememberNavController()

    val ctx = LocalContext.current
    val container = remember {
        AppContainer(ctx.applicationContext)
    }


    val settingsVm: SettingsViewModel = viewModel(factory = SettingsViewModelFactory(ctx))
    val filters = settingsVm.settings.collectAsState().value

    val favoritesVm: FavoritesViewModel =
        viewModel(factory = FavoritesViewModelFactory(container.favoritesRepository))

    val favoritesIds = favoritesVm.favorites.collectAsState().value.map { it.id }.toSet()

    Scaffold(
        bottomBar = {
            NavigationBar {
                val currentRoute = navController.currentBackStackEntryAsState().value?.destination?.route

                listOf(BottomDest.Repos, BottomDest.Favorites, BottomDest.Settings).forEach { dest ->
                    val icon = when (dest) {
                        BottomDest.Repos -> Icons.AutoMirrored.Filled.List
                        BottomDest.Favorites -> Icons.Default.Star
                        BottomDest.Settings -> Icons.Default.Settings
                    }

                    NavigationBarItem(
                        selected = currentRoute == dest.route,
                        onClick = {
                            navController.navigate(dest.route) {
                                popUpTo(BottomDest.Repos.route) { saveState = true }
                                launchSingleTop = true
                                restoreState = true
                            }
                        },
                        icon = { Icon(icon, contentDescription = dest.label) },
                        label = { Text(dest.label) }
                    )
                }
            }
        }
    ) { padding ->

        NavHost(
            navController = navController,
            startDestination = BottomDest.Repos.route,
            modifier = Modifier.padding(padding)
        ) {

            composable(BottomDest.Repos.route) {
                val reposVm: ReposViewModel = viewModel()

                LaunchedEffect(filters.owner) {
                    reposVm.load(owner = filters.owner)
                }

                ReposListScreen(
                    state = reposVm.state.collectAsState().value,
                    onRetry = { reposVm.load(owner = filters.owner) },
                    onRepoClick = { id -> navController.navigate("repo_details/$id") },
                    favoritesIds = favoritesIds,
                    onToggleFavorite = { repoUi -> favoritesVm.toggleFavorite(repoUi) }
                )
            }

            composable(
                "repo_details/{id}",
                arguments = listOf(navArgument("id") { type = NavType.LongType })
            ) { entry ->
                val reposVm: ReposViewModel = viewModel()
                val id = entry.arguments?.getLong("id") ?: -1L

                RepoDetailsScreen(
                    id = id,
                    reposVm = reposVm,
                    favoritesVm = favoritesVm,
                    onBack = { navController.popBackStack() }
                )
            }

            composable(BottomDest.Favorites.route) {
                FavoritesScreen(
                    onRepoClick = { id -> navController.navigate("repo_details/$id") }
                )
            }

            composable(BottomDest.Settings.route) {
                SettingsRoute(
                    onApplied = { navController.navigate(BottomDest.Repos.route) }
                )
            }
        }
    }
}
